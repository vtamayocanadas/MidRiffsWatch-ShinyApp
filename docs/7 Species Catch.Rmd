---
title: "7 Focal Species"
author: "Seleni Cruz"
date: "October 23, 2018"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
suppressPackageStartupMessages({
  library(tidyverse)
  library(here)
  library(ggplot2)
  library(dplyr)
  library(sf)
  library(rfishbase)
  library(plotly)
  library(reshape)
})
```


```{r, include=FALSE}
focalspecies<-read.csv(here::here("raw_data", "finalfocalspecies.csv"))
LandingSites<- read.csv (here::here("raw_data", "landingsites.csv"))%>%
  filter(Confirmado=="y") 


catch<- readRDS (here::here("raw_data", "conapesca.RDS"))%>%
  filter(Estado=="Baja california"| Estado=="Sonora")%>%
   filter(!(NombrePrincipal=="Macarela"|NombrePrincipal=="Sardina"|NombrePrincipal=="Camaron"|NombrePrincipal=="Corvina"|NombrePrincipal=="Calamar"|NombrePrincipal=="Anchoveta"))%>%
  merge(LandingSites, by="SitioDesembarque")%>%
  merge(focalspecies, by="NombreCientifico")%>%
  mutate(MT=PesoVivo/1000)

sum(catch$PesoVivo/1000)


#Calculating total landings for each 163 speies across all years, column years is the number of years for which data is available for that species    
#specieslanding<- catch%>%
 # group_by(NombreCientifico)%>%
  #summarize(sp_land= sum(MT), years=length(unique(Ano)))

#Calculating average landings of species across all years by species 
#toplandings<-specieslanding%>%
 # group_by(NombreCientifico)%>%
  #summarize(avergelandings=mean(MT))%>%
  #mutate(percent=(avergelandings/sum(avergelandings)*100))

#sum(toplandings$avergelandings)


#Calculate total catch in the region by year and number of species reported in each year 
spp_catch<-catch%>%
  group_by(NombreCientifico, Ano)%>%
  summarize(MT=sum(PesoVivo)/1000)%>%
  filter(length(unique(Ano))>5|length(unique(Ano))==5)%>%
  mutate(MT_20= MT*1.2, MT_40= MT*1.4, MT_60=MT*1.6)

sum(spp_catch$MT)

#write.csv(spp_catch, file = file.choose(new = T))

```


```{r, echo=FALSE, include=FALSE}

graph5 <-ggplot(spp_catch, aes(x=Ano, y=MT, color=NombreCientifico))+
  #tiff('yearly_catch_focal_species.tiff', units="in", width=10, height=5, res=300)+
  geom_line(size=1)+
  geom_point()+
  labs(x="Year", y="Yearly total catch catch (MT)", title="Catch series by Species", subtitle= "2000-2015")+
  theme_classic()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  theme(legend.title=element_blank())
graph5
ggplotly(graph5)


```



```{r, fig.width=8, fig.height=12, echo=FALSE}
graph6<-graph5+
   facet_wrap(~ NombreCientifico, scales = "free_y", ncol=2)

graph6
```



```{r, include=FALSE}
value2014<-spp_catch%>%
  filter(Ano=="2014")%>%
  merge(focalspecies, by="NombreCientifico")%>%
  mutate(total_min_value_2014=(MT*Min2014*0.053*1000), total_max_value_2014=(MT*Max2014*0.053*1000), total_avg_value_2014=(MT*Average2014*0.053*1000), value_percent=(total_avg_value_2014/sum(total_avg_value_2014)*100))

plot_ly(value2014, labels = ~NombreCientifico, values = ~total_avg_value_2014, type = 'pie', showlegend=FALSE) %>%
  layout(title = 'Revenue generated by focal species in 2014 in USD')

sum(value2014$total_avg_value_2014)
```

